{% if page.meta and page.meta.comments %}
<h2 id="__comments">ğŸ’¬ è¯„è®ºè®¨è®º</h2>
<div id="__comments_container" class="comments-container">
  <script>
    // æ ¹æ®å½“å‰ä¸»é¢˜è®¾ç½® Giscus ä¸»é¢˜
    function getGiscusTheme() {
      const palette = __md_get("__palette")
      if (palette && typeof palette.color === "object") {
        return palette.color.scheme === "slate" ? "dark" : "light"
      }
      return "light"
    }

    // åŠ¨æ€åŠ è½½ Giscus
    function loadGiscus() {
      // é¢„å…ˆæ·»åŠ æ ·å¼æ¥éšè— Giscus çš„é»˜è®¤åŠ è½½çŠ¶æ€
      const preStyle = document.createElement('style');
      preStyle.id = 'giscus-hide-loading';
      preStyle.textContent = `
        .giscus .giscus-loading,
        .giscus .giscus-loading-text,
        .giscus .giscus-loading-image,
        .giscus .giscus-loading-container,
        .giscus-loading {
          display: none !important;
          visibility: hidden !important;
        }
        .giscus iframe {
          opacity: 1 !important;
        }
      `;
      document.head.appendChild(preStyle);
      
      // éšè—åŠ è½½æç¤º
      const loadingElement = document.getElementById('comments-loading');
      
      const script = document.createElement('script');
      script.src = 'https://giscus.app/client.js';
      script.setAttribute('data-repo', 'dssast-tech/dssast-tech.github.io');
      script.setAttribute('data-repo-id', 'R_kgDOP9vGzQ'); // è¯·æ›¿æ¢ä¸ºä½ çš„å®é™…ä»“åº“ID
      script.setAttribute('data-category', 'General');
      script.setAttribute('data-category-id', 'DIC_kwDOP9vGzc4CwWVO'); // è¯·æ›¿æ¢ä¸ºä½ çš„å®é™…åˆ†ç±»ID
      script.setAttribute('data-mapping', 'pathname');
      script.setAttribute('data-strict', '0');
      script.setAttribute('data-reactions-enabled', '1');
      script.setAttribute('data-emit-metadata', '0');
      script.setAttribute('data-input-position', 'top'); // è¾“å…¥æ åœ¨é¡¶éƒ¨
      script.setAttribute('data-theme', getGiscusTheme());
      script.setAttribute('data-lang', 'zh-CN');
      script.setAttribute('crossorigin', 'anonymous');
      script.setAttribute('async', '');
      
      // å½“ Giscus åŠ è½½å®Œæˆæ—¶éšè—åŠ è½½æç¤º
      script.onload = function() {
        // ç­‰å¾… Giscus å®Œå…¨æ¸²æŸ“
        const checkGiscusLoaded = setInterval(() => {
          const giscusFrame = document.querySelector('.giscus iframe');
          if (giscusFrame) {
            document.getElementById('__comments_container').classList.add('giscus-loaded');
            
            // éšè— Giscus è‡ªå¸¦çš„åŠ è½½åŠ¨ç”»
            const giscusContainer = document.querySelector('.giscus');
            if (giscusContainer) {
              // æ·»åŠ è‡ªå®šä¹‰æ ·å¼æ¥éšè—åŠ è½½çŠ¶æ€
              const style = document.createElement('style');
              style.textContent = `
                .giscus .giscus-loading,
                .giscus .giscus-loading-text,
                .giscus .giscus-loading-image {
                  display: none !important;
                }
                .giscus .giscus-loading-container {
                  display: none !important;
                }
              `;
              document.head.appendChild(style);
              
              // ç›´æ¥è®¾ç½® iframe æ ·å¼
              const iframe = giscusFrame;
              if (iframe) {
                iframe.style.opacity = '1';
                iframe.style.display = 'block';
              }
            }
            
            clearInterval(checkGiscusLoaded);
          }
        }, 100); // æ›´é¢‘ç¹çš„æ£€æŸ¥
        
        // è¶…æ—¶ä¿æŠ¤ï¼Œæœ€å¤šç­‰å¾…10ç§’
        setTimeout(() => {
          document.getElementById('__comments_container').classList.add('giscus-loaded');
          clearInterval(checkGiscusLoaded);
        }, 10000);
      };
      
      document.getElementById('__comments_container').appendChild(script);
    }

    // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½è¯„è®º
    document.addEventListener('DOMContentLoaded', loadGiscus);

    // ä¸»é¢˜åˆ‡æ¢æ—¶é‡æ–°åŠ è½½è¯„è®º
    var ref = document.querySelector("[data-md-component=palette]")
    if (ref) {
      ref.addEventListener("change", function() {
        // æ˜¾ç¤ºåŠ è½½æç¤º
        const loadingElement = document.getElementById('comments-loading');
        if (loadingElement) {
          loadingElement.style.display = 'block';
        }
        
        // ç§»é™¤ giscus-loaded ç±»å¹¶æ¸…é™¤ç°æœ‰è¯„è®º
        const commentsContainer = document.getElementById('__comments_container');
        commentsContainer.classList.remove('giscus-loaded');
        
        const existingGiscus = commentsContainer.querySelector('.giscus');
        if (existingGiscus) {
          existingGiscus.remove();
        }
        
        // é‡æ–°åŠ è½½è¯„è®º
        setTimeout(loadGiscus, 100);
      })
    }
  </script>
  
  <!-- è¯„è®ºåŠ è½½æç¤º -->
  <div id="comments-loading">
    <div class="spinner"></div>
    æ­£åœ¨åŠ è½½è¯„è®º...
  </div>
  
  <style>
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .comments-container {
      margin-top: 2rem;
    }
    
    #comments-loading {
      text-align: center;
      padding: 2rem;
      color: #666;
    }
    
    #comments-loading .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #666;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    /* å½“ Giscus åŠ è½½å®Œæˆåéšè—åŠ è½½æç¤º */
    .giscus-loaded #comments-loading {
      display: none !important;
    }
    
    /* éšè— Giscus è‡ªå¸¦çš„åŠ è½½åŠ¨ç”»å’Œæ–‡å­— */
    .giscus .giscus-loading {
      display: none !important;
    }
    
    /* éšè— Giscus iframe çš„åˆå§‹åŠ è½½çŠ¶æ€ */
    .giscus iframe[src*="loading"] {
      display: none !important;
    }
    
    /* å…¨é¢éšè— Giscus çš„æ‰€æœ‰åŠ è½½ç›¸å…³å…ƒç´  */
    .giscus .giscus-loading,
    .giscus .giscus-loading-text,
    .giscus .giscus-loading-image,
    .giscus .giscus-loading-container,
    .giscus-loading,
    [class*="giscus-loading"] {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }
    
    /* ç¡®ä¿ Giscus å†…å®¹ç«‹å³æ˜¾ç¤ºï¼Œä¸æ˜¾ç¤ºåŠ è½½çŠ¶æ€ */
    .giscus {
      min-height: 0 !important;
    }
    
    .giscus iframe {
      opacity: 1 !important;
    }
  </style>
</div>
{% endif %}